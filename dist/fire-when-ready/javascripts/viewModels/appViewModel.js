define(["lib/knockout","tax_brackets","highcharts","lib/koExternalTemplateEngine_all.min","bootstrap"],function(e,t){function n(){function r(e){return Math.round(e*100)/100}function i(t){return{age:e.observable(t.age()+1),grossIncome:e.observable(t.grossIncome()),_401k:e.observable(t._401k()),roth:e.observable(t.roth()),afterTax:e.observable(t.afterTax()),principal:e.observable(r(t.valueAfterYears(1))),filingStatus:e.observable(t.filingStatus()),isExpanded:e.observable(!0)}}function s(){return n.isAdvanced()?"Value in Dollars":"Percent of Gross Income"}function o(){return n.isAdvanced()?"Age":"Years from Today"}var n=this;n.returnRate=e.observable(7),n.safeWithdrawalRate=e.observable(4),n.isAdvanced=e.observable(!1),n.filingStatuses=e.observable(t),n.simpleSavingsRate=e.observable(10),n.isAdvanced.subscribe(function(e){$("#container").highcharts().yAxis[0].axisTitle.attr({text:s()}),$("#container").highcharts().xAxis[0].axisTitle.attr({text:o()})}),n.ages=e.computed(function(){var e=[];for(var t=16;t<100;t++)e.push(t);return e}),n.snapshots=e.observableArray([{age:e.observable(22),grossIncome:e.observable(0),_401k:e.observable(0),roth:e.observable(0),afterTax:e.observable(0),principal:e.observable(0),filingStatus:e.observable(n.filingStatuses()[0]),isExpanded:e.observable(!0)}]),n.snapshots.subscribe(function(t){$.each(n.snapshots(),function(t,i){i.panelTitle=e.computed(function(){return"Age: "+i.age()}),i.panelCollapseText=e.computed(function(){return i.isExpanded()?"Collapse":"Expand"}),i.togglePanel=function(){i.isExpanded(!i.isExpanded())},i.netIncome=e.computed(function(){var e=i.grossIncome()-i._401k(),t=0;return $.each(i.filingStatus().brackets,function(n,r){if(!(e>=r.max))return t+=(e-r.min)*(1-r.rate),!1;t+=(r.max-r.min)*(1-r.rate)}),r(t)}),i.yearlySpend=e.computed(function(){return r(i.netIncome()-i.roth()-i.afterTax())}),i.monthlySpend=e.computed(function(){return r(i.yearlySpend()/12)}),i.weeklySpend=e.computed(function(){return r(i.monthlySpend()/4)}),i.dailySpend=e.computed(function(){return r(i.monthlySpend()/30.4)}),i.yearlyInvestment=e.computed(function(){return r(+i._401k()+ +i.roth()+ +i.afterTax())}),i.requiredRetirementAmount=function(){return n.isAdvanced()?i.yearlySpend()/(n.safeWithdrawalRate()/100):(100-n.simpleSavingsRate())/.04},i.valueAfterYears=function(e){var t=0,r=.07,s=n.simpleSavingsRate();n.isAdvanced()&&(t=+i.principal(),r=+n.returnRate()/100,s=+i.yearlyInvestment());var o=1+r;return t*Math.pow(o,e)+s*((Math.pow(o,e+1)-o)/r)}})}),n.snapshotAges=e.computed(function(){var e=[],t=n.snapshots();return $.each(t,function(t,n){e.push(n.age())}),e.sort(function(e,t){return e-t})}),n.snapshots.valueHasMutated(),n.isDeleteVisible=e.computed(function(){return n.snapshots().length>1?!0:!1}),n.firstSnap=e.observable(n.snapshots()[0]),n.showSimple=function(){n.isAdvanced(!1)},n.showAdvanced=function(){n.isAdvanced(!0)},n.newSnapshot=function(){var e=n.snapshots()[n.snapshots().length-1];n.snapshots.push(i(e))},n.deleteSnapshot=function(e){var t=$.inArray(e,n.snapshots());n.snapshots.splice(t,1)},n.simpleRequiredRetirementAmount=function(){return(100-n.simpleSavingsRate())/.04},n.simpleValueAfterYears=function(e){var t=0,r=.07,i=n.simpleSavingsRate(),s=1+r;return t*Math.pow(s,e)+i*((Math.pow(s,e+1)-s)/r)},n.retirementAccountSeries=e.computed(function(){var e=[];if(n.isAdvanced())$.each(n.snapshotAges(),function(t,i){var s=50;if(t!==n.snapshotAges().length-1){var o=n.snapshotAges()[t+1];s=o-i}$.each(n.snapshots(),function(t,n){if(n.age()===i)for(var o=0;o<s;o++){var u=r(n.valueAfterYears(o));e.push([n.age()+o,u]),u>n.requiredRetirementAmount()&&o+10<s&&(s=o+10)}})});else{var t=50;for(var i=0;i<t;i++){var s=r(n.simpleValueAfterYears(i));e.push(s),s>n.simpleRequiredRetirementAmount()&&i+10<t&&(t=i+10)}}return e}),n.requiredPortfolioSeries=e.computed(function(){var e=[];if(n.isAdvanced())$.each(n.snapshotAges(),function(t,i){var s=n.retirementAccountSeries().length-e.length;if(t!==n.snapshotAges().length-1){var o=n.snapshotAges()[t+1];s=o-i}$.each(n.snapshots(),function(t,n){if(n.age()===i)for(var o=0;o<s;o++)e.push([n.age()+o,r(n.requiredRetirementAmount())])})});else for(var t=0;t<n.retirementAccountSeries().length;t++)e.push(r(n.simpleRequiredRetirementAmount()));return e}),n.retirementAccountSeries.subscribe(function(e){$("#container").highcharts().series[0].setData(e)}),n.requiredPortfolioSeries.subscribe(function(e){$("#container").highcharts().series[1].setData(e)}),n.snapshotWeightedAverage=function(e){var t=n.retirementAccountSeries().length,i=0,s=0;return $.each(n.snapshotAges(),function(r,o){var u=t-i;if(r!==n.snapshotAges().length-1){var a=n.snapshotAges()[r+1];u=a-o,i+=u}$.each(n.snapshots(),function(t,n){n.age()===o&&(s+=n[e]()*u)})}),r(s/t)},n.netIncome=e.computed(function(){return n.snapshotWeightedAverage("netIncome")}),n.yearlySpend=e.computed(function(){return n.snapshotWeightedAverage("yearlySpend")}),n.monthlySpend=e.computed(function(){return n.snapshotWeightedAverage("monthlySpend")}),n.weeklySpend=e.computed(function(){return n.snapshotWeightedAverage("weeklySpend")}),n.dailySpend=e.computed(function(){return n.snapshotWeightedAverage("dailySpend")}),n.yearlyInvestment=e.computed(function(){return n.snapshotWeightedAverage("yearlyInvestment")}),$(function(){$("#container").highcharts({chart:{type:"line"},title:{text:null},yAxis:{title:{text:s()}},xAxis:{title:{text:o()}},series:[{name:"Portfolio Value",data:n.retirementAccountSeries()},{name:"Req. Portfolio Value",data:n.requiredPortfolioSeries()}],tooltip:{formatter:function(){if(n.isAdvanced()){var e="Age: "+this.x+"<br/>";return e.concat(this.series.name+": $"+this.y)}var e="Year: "+this.x+"<br/>";return e.concat(this.series.name+": "+this.y+"%")}}})})}e.applyBindings(new n)});